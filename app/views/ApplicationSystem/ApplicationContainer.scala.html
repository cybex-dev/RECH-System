@import java.util

@import models.ApplicationSystem.{ApplicationStatus, Question}
@import net.ddns.cyberstudios.Element
@import play.data.DynamicForm
@import play.twirl.api.Html
@import views.html.Templates.Masterpage
@import views.html.ApplicationSystem.fragmentFilterQuestions
@import views.html.Components._

@import dao.ApplicationSystem.EntityEthicsApplicationPK
@(pageTitle: String)(applicationType: String)(root: Element)(status: ApplicationStatus)(questionList: util.List[Question])(editableMap: Map[String, Boolean])(callback: play.api.mvc.Call)(showQuestions: Boolean)(applicationId: String)(approve: Boolean)(feedback: Boolean)




































































@application_content = @{












































    def createComponent(element: Element): String = {
        val elementType = element.getType.toLowerCase
        var q = ""
        val hint = element.getHint
        val id = element.getId
        var a = ""
        if(element.getChildren.size()==3){
            q = element.getChildren.get(1).getValue.toString
        } else {
            q = element.getChildren.getFirst.getValue.toString
        }
        val editable = editableMap.get(id)
        elementType match {
            case "boolean" =>
                /*creates checkbox*/
                var autofill = ""
                if(element.getAttributes.get("autofill_id") != null  && !feedback) {
                    autofill = APIController.getDataDirect(element.getAttributes.get("autofill_id")).get(0)
                }
                a = element.getChildren.getLast.getValue.toString
                var value = if(a.isEmpty) {
                    autofill
                } else a
                if(element.getAttributes().get("radiogroup") == null) {
                    inputCheckbox.apply(id, q, value, hint, editable, feedback).toString()
                } else {
                    if(element.getAttributes().get("radiogroup").equals("true")) {
                        var childItems = element.getChildren().get(0).getChildren().map(f => f.getValue.toString).toList
                        inputRadiobuttonGroup.apply(id, q, value, childItems, hint, editable, feedback).toString()
                    } else {
                        inputCheckbox.apply(id, q, value, hint, editable, feedback).toString()
                    }
                }

            case "number" =>
                var autofill = ""
                if(element.getAttributes.get("autofill_id") != null  && !feedback) {
                    autofill = APIController.getDataDirect(element.getAttributes.get("autofill_id")).get(0)
                }
                a = element.getChildren.getLast.getValue.toString
                var value = if(a.isEmpty) {
                    autofill
                } else a

                if(element.getAttributes().get("dropdown") == null) {
                    inputText.apply(id, q, value, hint, editable, feedback).toString()
                } else {
                    if(element.getAttributes().get("dropdown").equals("true")) {
                        if(element.getAttributes.get("db-mapping") == null) {
                            val childItems = element.getChildren().get(0).getChildren().map(f => f.getValue.toString).toList
                            inputDropdown.apply(id, q, value, childItems, hint, editable, feedback).toString()
                        } else {
                            val childItems = APIController.getDataDirect(element.getAttributes.get("db-mapping"))
                            inputDropdown.apply(id, q, value, childItems, hint, editable, feedback).toString()
                        }
                    } else {
                        inputText.apply(id, q, value, hint, editable, feedback).toString()
                    }
                }
            /*creates text field with number specific*/

            case "long_text" =>
                /*creates a multiline text field*/
                inputTextArea.apply(id, q, a, hint, element.getAttributes.get("max-words"), editable, feedback).toString()

            case "text" =>
                /*creates text field*/
                var autofill = ""
                if(element.getAttributes.get("autofill_id") != null && !feedback) {
                    autofill = APIController.getDataDirect(element.getAttributes.get("autofill_id")).get(0)
                }
                a = element.getChildren.getLast.getValue.toString
                var value = if(a.isEmpty) {
                    autofill
                } else a

                var isDataList = false;
                if(element.getAttributes().get("datalist") != null){
                    if(element.getAttributes().get("datalist").equals("true")){
                        isDataList = true
                    }
                }

                var isDropdown = false;
                if(element.getAttributes().get("dropdown") != null){
                    if(element.getAttributes().get("dropdown").equals("true")){
                        isDropdown = true
                    }
                }

                var dbMapping: String = ""
                if(element.getAttributes().get("db-mapping") != null){
                    dbMapping = element.getAttributes().get("db-mapping")
                }

                if(isDataList) {
                    val data: List[String] = APIController.getDataDirect(id)
                    inputDatalist.apply(id, q, value, data, hint, editable, feedback).toString
                } else {
                    if (isDropdown) {
                        if (!dbMapping){
                            val childItems = element.getChildren().get(0).getChildren().map(f => f.getValue.toString).toList
                            inputDropdown.apply(id, q, value, childItems, hint, editable, feedback).toString()
                        } else {
                            val childItems = APIController.getDataDirect(element.getAttributes.get("db-mapping"))
                            inputDropdown.apply(id, q, value, childItems, hint, editable, feedback).toString()
                        }
                    } else {
                        inputText.apply(id, q, value, hint, editable, feedback).toString()
                    }
                }

            case "date" =>
                /*creates text field*/
                var autofill = ""
                if(element.getAttributes.get("autofill_id") != null  && !feedback) {
                    autofill = APIController.getDataDirect(element.getAttributes.get("autofill_id")).get(0)
                }
                a = element.getChildren.getLast.getValue.toString
                var value = if(a.isEmpty){ autofill } else a
                inputDate.apply(id, q, value, hint, editable, feedback).toString()

            case "document" =>
                /*creates text field*/
                var req = element.getAttributes.get("required")
                if (req == null) {
                    req = "false"
                }
                val desc = element.getAttributes.get("desc")
                val id = element.getChildren.getLast.getValue.toString
                if(id.isEmpty) {
                    inputFile.apply(id, q, "", "", hint, desc, req, editable, feedback).toString()
                } else {
                    val shortName = id.split("~\\d+~").lift(1).get
                    inputFile.apply(id, q, id, shortName, hint, desc, req, editable, feedback).toString()
                }

            case "list" =>
                "<p>List Here</p><ul><li>list item 1</li><li>list item 2</li><li>list item 3</li></ul>"

            case _ =>
                "<p>Unhandled Tag : " + element.getType.toLowerCase() + "</p>"
        }
    }

    def getHeading(tag: String, title: String): String = {
        tag match {
            case "section" => "<h2>" + title + "</h2>"
            case "group" => "<h3>" + title + "</h3>"
            case "list" => "<h4>" + title + "</h4>"
            case _ => ""
        }
    }

    def parseElement(element: Element): String = {
        val innerText = for(elem: Element <- element.getChildren) yield {
            if(!elem.isComponent) {
                /*this creates a container element which consumes some html type text*/
                val innerText = parseElement(elem)
                val isList = elem.getTag.equals("list")
                val heading: String = getHeading(elem.getTag, elem.getAttributes.get("name"))
                if(isList) {
                    val pre = elem.getPreTag("table")
                    val post = elem.getPostTag("table")
                    heading + pre + "<thead><tr>" + innerText + "</tr></thead>" + post
                } else {
                    val pre = elem.getPreTag("div")
                    val post = elem.getPostTag("div")
                    pre + heading + innerText + post
                }
            } else {
                /*this creates a component of type a specific type*/
                val isListItem = element.getTag.equals("list")
                val value = createComponent(elem)
                if(isListItem) {
                    "<th>" + value + "</th>"
                } else {
                    value
                }
            }
        }
        innerText.mkString("")
    }

    Html(parseElement(root))
}

































@bodyBlock = {
    <br>
    <h2>Create Ethics Application for @applicationType Research</h2>
    <br>
    <div class="wizard-container">
        <div class="wizard-header">

        </div>
        <div class="wizard-body-container">
            <div class="wizard-progress-container">

            </div>
            <div class="wizard-body">
                <div class="row">
                    @*<div class="col-sm-9">*@
                    <div class="col-sm-12">
                        @helper.form(action = helper.CSRF.apply(callback), 'enctype -> "multipart/form-data", 'id -> "application_form") {
                            <input type="hidden" value="" id="application_level" name="application_level">
                            <input type="hidden" value="false" id="application_questions_shown" name="application_questions_shown">
                            <input type="hidden" value="@applicationType" id="application_type" name="application_type">
                            <input type="hidden" value="@applicationId" id="application_id" name="application_id">
                            @application_content
                            <br>
                            @if(feedback){
                                <script src="@routes.Assets.versioned("javascripts/reviewer.js")" type="text/javascript"></script>
                            }

                            <div class="col-sm-6">
                            @if(feedback){
                                <a href="@controllers.UserSystem.routes.ProfileHandler.overview()">
                                    <button type="submit" class="nmu-button" style="width: auto; float: left">Cancel</button>
                                </a>
                            } else {
                                @if(approve) {
                                    <a href="@controllers.UserSystem.routes.ProfileHandler.overview()">
                                        <button type="submit" class="nmu-button" style="width: auto; float: left">Cancel</button>
                                    </a>
                                } else {
                                    <button type="submit" class="nmu-button" style="width: auto;
                                            float: left">@if(showQuestions) {Save Application} else {Update Application}</button>
                                }
                            }
                            </div>
                            <div class="col-sm-6">
                                @if(feedback){
                                    <a href="@controllers.ReviewSystem.routes.ReviewHandler.submitReview()">
                                        <button type="submit" class="nmu-button" style="width: auto; float: right">Submit Feedback</button>
                                    </a>
                                } else {
                                    @if(approve){
                                        <a href="@controllers.ReviewSystem.routes.ReviewHandler.doViewApprove()">
                                            <button type="submit" class="nmu-button" style="width: auto; float: right">Approve Application</button>
                                        </a>
                                    } else {
                                        <a href="@controllers.ApplicationSystem.routes.ApplicationHandler.forceSubmitApplication">
                                            <button type="submit" class="nmu-button" style="width: auto; float: right">Submit Application</button>
                                        </a>
                                    }
                                }
                            </div>
                        }
                    </div>
                    @*<div class="col-sm-3">*@
                        @*<div id="application_overview_container" style="margin: 10px; padding: 10px; border: 1px solid #ffffff">*@
                            @*<h5>Application Overview</h5>*@
                        @*</div>*@
                        @*<div id="documents_overview_container" style="margin: 10px; padding: 10px; border: 1px solid #ffffff">*@
                            @*<h5>Required Documents</h5>*@
                        @*</div>*@
                    @*</div>*@
                </div>
            </div>
        </div>
    </div>
}

@Masterpage.apply(pageTitle){
    @bodyBlock
    @if(showQuestions) {
        @fragmentFilterQuestions.apply(questionList)
    } else {}
}
