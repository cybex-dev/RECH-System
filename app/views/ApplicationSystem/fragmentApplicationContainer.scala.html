@import java.util
@import models.ApplicationSystem.{ApplicationStatus, Question}
@import net.ddns.cyberstudios.Element
@import play.data.DynamicForm
@import play.twirl.api.Html
@import views.html.Templates.Masterpage
@import views.html.ApplicationSystem._
@import views.html.Components._
@import dao.ApplicationSystem.EntityEthicsApplicationPK
@import controllers.APIController

@(root: Element)(editableMap: util.Map[String, Boolean])(showFeedback: Boolean)(showReviewContainer: Boolean)(reviewDataMap: util.Map[String, util.List[String]])

@application_content = @{
    def createComponent(element: Element, newId: String): String = {
        val elementType = element.getType.toLowerCase
        var q = ""
        val hint = element.getHint
        val id = newId
        var a = ""
        if(element.getChildren.size() == 3) {
            q = element.getChildren.get(1).getValue.toString
        } else {
            q = element.getChildren.getFirst.getValue.toString
        }
        val reviewFeedback = reviewDataMap.get(id)
        var editable = false
        if(id.matches("^\\w+[_]\\d+$")) {
            val newId = id.substring(0, id.lastIndexOf("_"))
            editable = editableMap.get(newId)
        } else {
            editable = editableMap.get(id)
        }

        elementType match {
            case "boolean" =>
                /*creates checkbox*/
                var autofill = ""
                if(element.getAttributes.get("autofill_id") != null && !showFeedback) {
                    autofill = APIController.getDataDirect(element.getAttributes.get("autofill_id")).get(0)
                }
                a = element.getChildren.getLast.getValue.toString
                var value = if(a.isEmpty) {
                    autofill
                } else a
                if(element.getAttributes().get("radiogroup") == null) {
                    inputCheckbox.apply(id, q, value, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                } else {
                    if(element.getAttributes().get("radiogroup").equals("true")) {
                        var childItems = element.getChildren().get(0).getChildren().map(f => f.getValue.toString).toList
                        inputRadiobuttonGroup.apply(id, q, value, childItems, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                    } else {
                        inputCheckbox.apply(id, q, value, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                    }
                }

            case "number" =>
                var autofill = ""
                if(element.getAttributes.get("autofill_id") != null && !showFeedback) {
                    autofill = APIController.getDataDirect(element.getAttributes.get("autofill_id")).get(0)
                }
                a = element.getChildren.getLast.getValue.toString
                var value = if(a.isEmpty) {
                    autofill
                } else a

                if(element.getAttributes().get("dropdown") == null) {
                    inputText.apply(id, q, value, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                } else {
                    if(element.getAttributes().get("dropdown").equals("true")) {
                        if(element.getAttributes.get("db-mapping") == null) {
                            val childItems = element.getChildren().get(0).getChildren().map(f => f.getValue.toString).toList
                            inputDropdown.apply(id, q, value, childItems, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                        } else {
                            val childItems = APIController.getDataDirect(element.getAttributes.get("db-mapping"))
                            inputDropdown.apply(id, q, value, childItems, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                        }
                    } else {
                        inputText.apply(id, q, value, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                    }
                }
            /*creates text field with number specific*/

            case "long_text" =>
                /*creates a multiline text field*/
                inputTextArea.apply(id, q, element.getChildren().getLast().getValue().toString, hint, element.getAttributes.get("max-words"), editable, showFeedback, showReviewContainer, reviewFeedback).toString()

            case "text" =>
                /*creates text field*/
                var autofill = ""
                if(element.getAttributes.get("autofill_id") != null && !showFeedback) {
                    autofill = APIController.getDataDirect(element.getAttributes.get("autofill_id")).get(0)
                }
                a = element.getChildren.getLast.getValue.toString
                var value = if(a.isEmpty) {
                    autofill
                } else a

                var isDataList = false;
                if(element.getAttributes().get("datalist") != null) {
                    if(element.getAttributes().get("datalist").equals("true")) {
                        isDataList = true
                    }
                }

                var isDropdown = false;
                if(element.getAttributes().get("dropdown") != null) {
                    if(element.getAttributes().get("dropdown").equals("true")) {
                        isDropdown = true
                    }
                }

                var dbMapping: String = ""
                if(element.getAttributes().get("db-mapping") != null) {
                    dbMapping = element.getAttributes().get("db-mapping")
                }

                if(isDataList) {
                    val data: List[String] = APIController.getDataDirect(id)
                    inputDatalist.apply(id, q, value, data, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString
                } else {
                    if(isDropdown) {
                        if(!dbMapping) {
                            val childItems = element.getChildren().get(0).getChildren().map(f => f.getValue.toString).toList
                            inputDropdown.apply(id, q, value, childItems, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                        } else {
                            val childItems = APIController.getDataDirect(element.getAttributes.get("db-mapping"))
                            inputDropdown.apply(id, q, value, childItems, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                        }
                    } else {
                        inputText.apply(id, q, value, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                    }
                }

            case "date" =>
                /*creates text field*/
                var autofill = ""
                if(element.getAttributes.get("autofill_id") != null && !showFeedback) {
                    autofill = APIController.getDataDirect(element.getAttributes.get("autofill_id")).get(0)
                }
                a = element.getChildren.getLast.getValue.toString
                var value = if(a.isEmpty) {
                    autofill
                } else a
                inputDate.apply(id, q, value, hint, editable, showFeedback, showReviewContainer, reviewFeedback).toString()

            case "document" =>
                /*creates text field*/
                var req = element.getAttributes.get("required")
                if(req == null) {
                    req = "false"
                }
                val desc = element.getAttributes.get("desc")
                val v = element.getChildren.getLast.getValue.toString
                if(v.isEmpty) {
                    inputFile.apply(id, q, "", "", hint, desc, req, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                } else {
                    val shortName = v.split("~\\d+~").lift(1).get
                    inputFile.apply(id, q, v, shortName, hint, desc, req, editable, showFeedback, showReviewContainer, reviewFeedback).toString()
                }

            case "list" =>
                "<p>List Here</p><ul><li>list item 1</li><li>list item 2</li><li>list item 3</li></ul>"

            case _ =>
                "<p>Unhandled Tag : " + element.getType.toLowerCase() + "</p>"
        }
    }

    def getHeading(tag: String, title: String): String = {
        tag match {
            case "section" => "<h2>" + title + "</h2>"
            case "group" => "<h3>" + title + "</h3>"
            case "list" => "<h4>" + title + "</h4>"
            case _ => ""
        }
    }

    /**
      * Tag requires start and end tag like <tag>...</tag> to work. These tags must be directly after one another with no new tags inbetween
      * @param component
      * @param tag
      * @return
      */
    def removeElement(component: String, tag: String): String = {
        // Find location of tag  - 1
        //   <tag...</tag>
        //   ^        location - 1
        val startLocation = component.indexOf("<" + tag)

        // Start search location = startLocation + 2
        //  <tag>...</tag>
        //  ^    ^ search start past closing start tag angle bracket
        val endLocation = component.indexOf("</" + tag + ">", startLocation + tag.length + 2) + tag.length + 3

        // Find location of tag  - 1
        //   <tag...</tag>
        //          ^    finds end location + tag length + 1. Ends on closing angle bracket

        //copy substring (+1 for exclusive end)
        val element = component.substring(startLocation, endLocation)

        // get substring excluding current tag
        val comp = component.substring(endLocation)
        comp
    }

    def createBasicElement(element: Element, index: Int): String = {
        val newId = element.getId.concat("_").concat(String.valueOf(index))
        element.getAttributes.put("id", newId)
        // Set these values into the element and pass it to the component constructor
        // Retrieve the created component, remove the label and IC and add it to the childList
        //println("Creating TR item: [" + newId + "] -> EMPTY")

        //cleanup
        var component = createComponent(element, newId)
        component = component.replace("<br>", "")
        component = component.trim()

        // remove label
        val tuple = removeElement(component, "label")
        component = tuple

        //remove icon
        val tuple1 = removeElement(component, "ic")
        component = tuple1
        component = component.trim

        //get element
        val e = component
        //println("element = " + e)

        // Add new component
        val td = "<td>" + component + "</td>"
        println("Table Row created as single:\n\t<td>" + component + "</td>")
        return td
    }

    def processList(elem: Element): String = {
        val componentList = new Array[Array[String]](elem.getChildren.size)

        var componentListIndex = 0

        var maxSize = 0

        for (e: Element <- elem.getChildren) {
            if(e.getChildren.getLast.getValue.isInstanceOf[util.ArrayList[Object]]){
                val list = e.getChildren.getLast.getValue.asInstanceOf[util.ArrayList[Object]]
                if (maxSize < list.size()) {
                    maxSize = list.size()
                }
            }
        }

        // Create all components
        for(element: Element <- elem.getChildren) {

            // Create list to store each child's components which are generated from the array list
            val elementId = element.getId

            // Check if arraylist
            if(element.getChildren.getLast.getValue.isInstanceOf[util.ArrayList[Object]]) {
                println("value IS an arraylist")

                // Get the list of child element values and iterate over them
                var dataList = element.getChildren.getLast.getValue.asInstanceOf[util.ArrayList[Object]]
                var childElementList = new Array[String](dataList.size())

                // Using createComponent, we create each component and remove the associated labels and hints

                for(ii <- 0 until dataList.size()) {
                    val elementValue = dataList(ii)
                    // Set the value by using setValue
                    if(elementValue.isInstanceOf[Boolean]) {
                        element.getChildren.getLast.setValue(elementValue.asInstanceOf[Boolean])
                    } else {
                        element.getChildren.getLast.setValue(elementValue.asInstanceOf[String])
                    }

                    val newId = elementId.concat("_").concat(String.valueOf(ii + 1))
                    element.getAttributes.put("id", newId)

                    //cleanup
                    var component = createComponent(element, newId)
                    component = component.replace("<br>", "")
                    component = component.trim()

                    // remove label
                    val tuple = removeElement(component, "label")
                    component = tuple

                    //remove icon
                    val tuple1 = removeElement(component, "ic")
                    component = tuple1
                    component = component.trim

                    // Add new component
                    childElementList(ii) = "<td>" + component + "</td>"
                }

                for(iii <- dataList.size() until (maxSize - dataList.size())){
                    val component = createBasicElement(element, iii)
                    childElementList(iii) = component
                }

                componentList(componentListIndex) = childElementList
                componentListIndex += 1

            } else {
                println("value: not an arraylist, creating single element")

                val td = createBasicElement(element, 1)
                componentList(componentListIndex) = Array(td)
                componentListIndex += 1
            }

        }

        // create table header
        var tHeadTrContent = ""
        val elementList = elem.getChildren.toList
        for(e: Element <- elementList) yield {
            var content = ""

            //Determine column class type
            var className = ""

            if(e.getChildren.getFirst.getTag.toLowerCase.equals("question")) {
                // If simple question, get first child value
                content = e.getChildren.getFirst.getValue.toString

                //this is a simple input, make thead tr larger than vs dropdown (below)

                if(e.getType.toLowerCase().equals("boolean")) {
                    className = "col-sm-1"
                } else {
                    if(e.getType.toLowerCase().equals("number")) {
                        className = "col-sm-2"
                    } else {
                        if(e.getType.toLowerCase().equals("text")) {
                            className = "col-sm-4"
                        } else {
                            className = "col-sm-3"
                        }
                    }
                }

            } else {
                // If question has data element, get second child value
                content = e.getChildren.get(1).getValue.toString

                className = "col-sm-3"
            }

            val thStart = "<th class=\"" + className + "\">"
            val thEnd = "</th>"

            // Create TR element
            tHeadTrContent += thStart.concat(content).concat(thEnd)
        }
        // Add last column for remove button
        tHeadTrContent += "<th class=\"col-sm-1\"></th>"

        // Create tHead
        val tHead = "<thead><tr>".concat(tHeadTrContent).concat("</tr></thead>")

        // create table body
        // For each arraylist value, get element and set value
        var tBody = ""

        // parsing the data, get the first component list and get the number of items in that list
        // This is for the multiple values that can be stored in the components value i.e. the arraylist
        val numRows = componentList(0).length

        // For each of these rows, get componentlist.forEach child.getList and get i'th item
        for(i <- 0 until numRows) {
            var trRow: String = ""

            // For each child in componentList
            for(ii <- 0 until componentList.length) {
                val currentComponentListList = componentList(ii);

                val someItem = currentComponentListList(i)
                val ll = elementList
                println("[DEBUG] Comp : size = " + someItem.size)
                println("[DEBUG] Comp : {" + someItem + "}")
                val itemValue = someItem
                trRow += itemValue
            }

            // Check if this is a review, it is is NOT, then add delete button for each row
            if(!showReviewContainer) {
                val delButton = "<td><button type=\"button\" class=\"fa fa-trash action-alternative table-row-delete-button\" id=\"btnDelRow" + elem.getId + "_" + String.valueOf(i + 1) + "\"></button></td>"
                trRow = trRow.concat(delButton)
            }

            tBody += "<tr>" + trRow + "</tr>"
        }

        tBody = "<tbody>" + tBody + "</tbody>"

        //println("Final tbody: " + tBody)

        // Create table
        val heading = getHeading("list", elem.getAttributes.get("name"))
        var table = "<table id=\"" + elem.getId + "\" name=\"" + elem.getId + "\" class=\"table\">".concat(tHead).concat(tBody)

        // Check if this is a review page or edit page. If it is NOT a review page, then add 'add' button to table footer
        if(!showReviewContainer) {
            val tfoot = "<tfoot><tr><td colspan=\"" + String.valueOf(componentList.length) + "\"><button type=\"button\" class=\"nmu-button action-button action-alternative table-add-button\" id=\"btnAdd_" + elem.getId + "\">Add</button></td></tr></tfoot>"
            table = table.concat(tfoot)
        }

        table = table.concat("</table>")
        println("============================\nFinal table: \n" + table + "\n")
        table
    }

    def parseElement(element: Element): String = {
        val innerText = for(elem: Element <- element.getChildren) yield {
            if(elem.getTag.equals("list")) {
                processList(elem)
            } else {
                if(!elem.isComponent) {
                    /*this creates a container element which consumes some html type text*/
                    val innerText = parseElement(elem)
                    val heading: String = getHeading(elem.getTag, elem.getAttributes.get("name"))
                    val pre = elem.getPreTag("div")
                    val post = elem.getPostTag("div")
                    pre + heading + innerText + post
                } else {
                    /*this creates a component of type a specific type*/
                    createComponent(elem, elem.getId)
                }
            }
        }
        innerText.mkString("")
    }

    Html(parseElement(root))
}

@application_content